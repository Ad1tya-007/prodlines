name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-checks:
    name: PR Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for console.log statements
        run: |
          if grep -r "console\.log" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next .; then
            echo "⚠️  Warning: Found console.log statements. Consider removing them before merging."
            exit 0
          fi

      - name: Check for TODO/FIXME comments
        run: |
          if grep -r "TODO\|FIXME" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next .; then
            echo "ℹ️  Found TODO/FIXME comments. Review them before merging."
            exit 0
          fi

      - name: Check file sizes
        run: |
          find . -name "*.tsx" -o -name "*.ts" | grep -v node_modules | grep -v .next | while read file; do
            lines=$(wc -l < "$file")
            if [ $lines -gt 500 ]; then
              echo "⚠️  Warning: $file has $lines lines. Consider splitting it."
            fi
          done

      - name: Validate environment variables
        run: |
          if [ ! -f .env.example ]; then
            echo "⚠️  Warning: .env.example file not found. Consider adding one."
          fi

      - name: Check migration files
        run: |
          if [ -d "supabase/migrations" ]; then
            for migration in supabase/migrations/*.sql; do
              if [ -f "$migration" ]; then
                if ! grep -q "^--" "$migration"; then
                  echo "⚠️  Warning: $migration might benefit from a comment describing its purpose."
                fi
              fi
            done
          fi
